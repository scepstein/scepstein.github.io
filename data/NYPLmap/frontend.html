<!DOCTYPE html>
<html>
  <head>
    <title>Library Finder</title>
  </head>
  <body>
    <form id="website-form">
        <input type="text" name="website_link" placeholder="Enter website link here">
        <button type="submit">Submit</button>
    </form>
    <div id="map" style="height: 500px; width: 100%;"></div>
    <script>
        document.getElementById("website-form").addEventListener("submit", function(event) {
        event.preventDefault();
        var website_link = document.querySelector('input[name="website_link"]').value;
        fetch('https://local-shoreline-375902.uc.r.appspot.com/libraries', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ website_link: website_link })
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            console.log(data);
            globalData = data;
            var src = `https://maps.googleapis.com/maps/api/js?key=${data.api_key}&callback=initMap`;
            var script = document.createElement('script');
            script.src = src;
            document.body.appendChild(script);
        });
    }, { passive: false });

    function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 40.7831, lng: -73.9712},
                zoom: 11.5
            });
            var markers = [];
    for (var i = 0; i < globalData.map_data.length; i++) {
        var marker;
        if (globalData.map_data[i].category === "available") {
            marker = new google.maps.Marker({
                position: {lat: globalData.map_data[i].lat, lng: globalData.map_data[i].lng},
                map: map,
                icon: 'http://maps.google.com/mapfiles/ms/micons/blue-dot.png'
            });
        } else if (globalData.map_data[i].category === "unavailable") {
            marker = new google.maps.Marker({
                position: {lat: globalData.map_data[i].lat, lng: globalData.map_data[i].lng},
                map: map,
                icon: 'http://maps.google.com/mapfiles/ms/micons/red-dot.png'
            });
        }
        var infowindow = new google.maps.InfoWindow({
            content: globalData.map_data[i].name
        });
        marker.addListener('click', function() {
            infowindow.open(map, marker);
        });
        markers.push(marker);
        }
    }
    </script>
  </body>
</html>
